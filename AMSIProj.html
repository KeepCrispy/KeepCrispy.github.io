<!doctype html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Jekyll">
    <link rel="license" href="LICENSE">

    <meta name="application-name" content="Keeping it Crispy">
    <meta name="theme-color" content="">
    <link rel="archives" href="http://localhost:4000/archives/">

    <meta name="robots" content="index,follow"> <!-- All Search Engines -->
    <meta name="googlebot" content="index,follow"><!-- Google Specific    -->

    <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/pure-min.css">
    <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/grids-responsive-min.css">
    <link rel="stylesheet" href="/assets/main.css">
    <link rel="stylesheet" href="/assets/code.css">
    <script src="https://kit.fontawesome.com/e9dddf84a6.js" crossorigin="anonymous"></script>
    <link rel="alternate" type="application/rss+xml" href="http://localhost:4000/feed.xml">
</head>
<body>

    <div id="layout" class="pure-g"><aside class="sidebar pure-u-1 pure-u-md-1-4">
    <div class="sidebar-info">
        <a href="/">
            <span hidden>Keeping it Crispy
                Header Image</span>
            <img class="brand-photo" src="/assets/profile.png" alt="Photo of AreWhyW"/>
        </a>
        <h1 class="brand-title">
            <a href="/">Keeping it Crispy</a>
        </h1>
        <h2 class="brand-tagline">AreWhyW, software engineer exploring security research</h2>

        <nav class="nav">
            <ul class="nav-list">
                <li class="nav-item">
                    <a class="pure-button" href="http://localhost:4000">Home</a>
                </li>
                <li class="nav-item">
                    <a class="pure-button" href="http://localhost:4000/notes">Notes</a>
                </li>
                <li class="nav-item">
                    <a class="pure-button" href="http://localhost:4000/journals">Journal</a>
                </li>
            </ul>
        </nav>
        
    </div>
</aside>
<div class="content pure-u-1 pure-u-md-3-4">
            <div class="md-display">
                <h1>
                    <a class="jekyll-header" href="/">Keeping it Crispy</a>
                </h1><div class="menu">
    <div class="about">
        <a href="/about">
            <i class="fas fa-signature"></i>
            About
        </a>
    </div>
    <div class="hashtags">
        <a href="/tags">
            <i class="fas fa-hashtag"></i>
            Tags
        </a>
    </div>
    <div class="categories">
        <a href="/categories">
            <i class="far fa-folder-open"></i>
            Categories
        </a>
    </div>
    <div class="archive">
        <a href="/archive">
            <i class="fas fa-archive"></i>
            Archive
        </a>
    </div>
</div>
<div id="search">
    <label>
        <span class="search-icon">ðŸ”Ž</span>
        <input autocomplete="off" id="search-input" oninput="changeResultContainerDisp(this.value)" placeholder="Search all articles..." type="text"/>
    </label>

    <ul id="results-container" style="display: none"></ul>
</div>
<script src="/assets/simple-jekyll-search.js"></script>
<script>
    function changeResultContainerDisp(val) {
        if (val) {
            document
                .getElementById("results-container")
                .style
                .display = "block";
            document.getElementById("search-input").addEventListener("blur", function () {
                document.addEventListener("click", function (event) {
                    var isClickInside = document.getElementById("results-container").contains(event.target);
                    if (! isClickInside) {
                        document
                            .getElementById("results-container")
                            .style
                            .display = "none";
                    }
                })
            })
        } else {
            document
                .getElementById("results-container")
                .style
                .display = "none";
        }
    }
    var sjs = SimpleJekyllSearch({
        searchInput: document.getElementById("search-input"),
        resultsContainer: document.getElementById("results-container"),
        json: "/search.json",
        searchResultTemplate: "<li class='search_res' style='list-style: none;'><a href='http://localhost:4000{url}' color: #555555;'><p><strong>></strong> {title}</p></a></li>",
        noResultsText: "No results found. Try another search.",
        fuzzy: false,
        limit: 5
    })
</script></div>
            <div>
                <article class="post-entry" itemscope itemtype="http://schema.org/BlogPosting">

    <header class="post-header">
        <h2 class="post-title" itemprop="name headline">Powershell AMSI Lab - evading using obfuscation and detection POC</h2><p><time datetime="2023-04-21T00:00:00-07:00" itemprop="datePublished">
        Apr 21, 2023
    </time>&#8239;
    <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">By: AreWhyW</span></span>&#8239;|&#8239;<a href="/tags/#AMSI">#AMSI</a> &#8239;<a href="/tags/#Powershell">#Powershell</a> &#8239;</p></header>

    <div articlebody" class="post-body itemprop=">
        <p>Iâ€™m pretty sure many developers like me have came across their code being flagged by windows defender as a virus or malware strictly because it was just doing its job accessing system functions or making a TCP connection to the network service. Having been frustrated by this many times, I wanted to figure out why my legit working code is being flagged with a false positive, while threat actors are able to bypass this security completely.</p>

<p>The Anti-Malware Scan Interface (AMSI) is a security technology built into the Windows 10 operating system. This interface serves as an open platform for allowing antivirus software to interact with Windows 10, allowing the antivirus program to detect and respond to malicious code. This helps to protect users from malicious software and provide a safer computing environment. AMSI is an essential tool for antivirus programs, as it allows them to detect and block malicious code more effectively. The interface also allows for more accurate detection of malicious code and provides more detailed information about the threats that are detected. This allows antivirus programs to more effectively protect users from threats, as well as provide a more secure computing experience.</p>

<p>If you look closely into Anti-Malware Scan Interface (AMSI) evasion vulnerabilities published over the years, extensive work has been put into this. Threat actors have developed several techniques to bypass AMSI detection. These techniques include encrypting the payload and decrypting it in memory inside PowerShell, splitting up the payload scripts and recombining them, and using different PowerShell encoding techniques. Additionally, attackers can embed the payload inside another executable, which will not be caught by AMSI until the executable is executed.</p>

<p>All these techniques were used by threat actors to bypass AMSI detection and it is important to be aware of them in order to understand how attackers can fly under the radar.</p>

<p>Panagiotis Chartas, a well known Security Researcher, made a great <a href="https://www.youtube.com/watch?v=tGFdmAh_lXE">video guide on obfuscation techniques</a></p>

<p>He also posted a great resource on his github: <a href="https://github.com/t3l3machus/PowerShell-Obfuscation-Bible">Powershell Obfuscation Bible</a></p>

<p>Based on his findings we know that that AMSI isnâ€™t quite able to catch obfuscated powershell code just yet.</p>

<p>Even though obfuscated code can easily be identified using definitions profiling. The problem though is much deeper, as anyone with programming experience would know that the same code can be easily redesigned with different nuances.</p>

<p>The possibilities of obfucation are endless and itâ€™s a recipe for disaster.</p>

<p>Panagiotis findings into this vulnerability means that, at present, it can be exploited using very simple obscuration with basic string manipulation, all without the need of external tools.</p>

<p>If a threat actor took advantage of this, their powershell scripts will easily fly under the radar.</p>

<p><strong>Remediation Strategies</strong></p>

<p>In order to mitigate the threat of malicious code bypassing AMSI detection, it is important to perform security audits on APIs being used, harden your network infrastructure, and make sure your systems are properly configured with good access control. Additionally, it is important to regularly update antivirus software and perform regular security audits and patching of the system.</p>

<p><strong>Pentesting Screenshots</strong></p>

<p>Here is a simple POC of an obfuscated shell encapsulated in an exe runtime that was generated using an obfuscator tool. It is being used to gain remote access in a custom lab. This was done with antivirus scans turned on.</p>

<p><img src="/assets/launchpsx_amsi1.png" alt="psx running custom payload" /></p>

<p>and what the reverse shell looks like once launched.</p>

<p><img src="/assets/customps_amsi1.png" alt="reverse" /></p>

<p><strong>My thoughts on remdiation strategies</strong></p>

<p>Obfuscation techniques include randomizing variable names, padding with more logic and inserting wrapper logic around the executed scripts. Because of the small file size requirement for most payloads to fly undetected when logged, it is likely that the core execution steps are unchanged to keep things compact. Thus even if the variable lengths changes, the logical pattern of function calls, and assigning variable values are likely unchanged when additional information is padded on. Making it somewhat possible to flag by scanning the program for execution logic patterns.</p>

<p>Iâ€™ve wrote a simple opensource <a href="https://github.com/KeepCrispy/BlueWyvern">POC BlueWyvern Scanner</a> to use Regex to catch obfuscated and some possibly malicious code that would require some deeper knowledge of yara to perform.</p>

<p><strong>Best Practices for Users</strong></p>

<p>In order to protect their systems from malicious code, users should follow best practices such as using strong passwords, avoiding suspicious links and downloads, and regularly checking server and operating system access logs. Additionally, users should be aware of the latest threats and tricks attackers use to bypass security measures.</p>

<p>It is always good practice to be engaging in DevSecOps to ensure the deployment pipeline and environments are monitored for integrity.</p>

<p>Checking server and operating system access logs is a good way to determine if there has been any malicious activity on the system. However, it is important to note that depending on the type of malware used, it may be difficult to detect the malicious activity in the logs.</p>

<p>It is always best to take preventative measures. This can include regularly auditing and patching the system. Making sure to regularly review access control measures. Additionally, it is important to ensure that users are following best practices when it comes to online security, such as using strong passwords and avoiding suspicious links and downloads.</p>


    </div><div id="author">
    <h3>About
        AreWhyW</h3>
    <img src="assets/profile.png" alt="Photo of AreWhyW"/>
    <p>Hi there, I'm a software engineer interested in exploring security research. My background in software engineering has given me the opportunity to develop secure code, review code, and conduct application security testing.</p>
</div><a class="u-url" href="/AMSIProj" hidden></a>
</article><hr/>

<footer class="footer">
    <div class="pure-menu pure-menu-horizontal">
        <ul>
            <li class="pure-menu-item">
                <a class="pure-menu-link" href="/">
                    <i class="fas fa-home"></i>
                    <span class="md-display">Home</span>
                </a>
            </li>

            <li class="pure-menu-item">
                <a class="pure-menu-link" href="https://github.com/keepcrispy">
                    <i class="fab fa-github"></i>
                    <span class="md-display">GitHub</span>
                </a>
            </li>
        </ul>
    </div>
</footer>
</div>
        </div>
    </div>

</body>

</html>
